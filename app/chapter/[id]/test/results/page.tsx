'use client';

import { useEffect, useState } from 'react';
import { useParams, useRouter, useSearchParams } from 'next/navigation';
import Link from 'next/link';

const TEST_QUESTIONS = [
  {
    id: 'q1',
    question: 'Sound is generated by the rhythmic _____ of any object.',
    options: ['vibration', 'rotation', 'movement', 'oscillation'],
    correctAnswer: 'A',
    explanation: 'Sound is generated by the rhythmic vibration of any object.'
  },
  {
    id: 'q2',
    question: 'The frequency of sound is measured in _____.',
    options: ['Decibel', 'Hertz', 'Meter', 'Newton'],
    correctAnswer: 'B',
    explanation: 'Frequency is measured in Hertz (Hz).'
  },
  {
    id: 'q3',
    question: 'If _____ of sound is decreased, its loudness also decreases.',
    options: ['frequency', 'pitch', 'intensity', 'speed'],
    correctAnswer: 'C',
    explanation: 'Intensity of sound determines loudness.'
  },
  {
    id: 'q4',
    question: 'A _____ is necessary for propagation of sound.',
    options: ['vacuum', 'medium', 'light', 'heat'],
    correctAnswer: 'B',
    explanation: 'Sound needs a medium to travel.'
  },
  {
    id: 'q5',
    question: 'Which musical instrument produces sound through vibrations in the air?',
    options: ['Tabla', 'Flute', 'Sitar', 'Harmonium'],
    correctAnswer: 'B',
    explanation: 'Flute produces sound by vibrating air.'
  },
  {
    id: 'q6',
    question: 'What is the unit for measuring sound level?',
    options: ['Hertz', 'Watt', 'Decibel', 'Pascal'],
    correctAnswer: 'C',
    explanation: 'Sound level is measured in decibels (dB).'
  },
  {
    id: 'q7',
    question: 'Why did people listen for trains by putting ear to rail?',
    options: [
      'Sound travels faster in solids than in air',
      'Rails are cooler',
      'It is a tradition',
      'Rails amplify sound'
    ],
    correctAnswer: 'A',
    explanation: 'Sound travels faster through solids.'
  },
  {
    id: 'q8',
    question: 'Why do tabla and sitar generate different sounds?',
    options: [
      'They are different colors',
      'They vibrate at different frequencies and have different structure',
      'One is louder',
      'They use different strings'
    ],
    correctAnswer: 'B',
    explanation: 'Different structure and frequencies create unique sounds.'
  },
  {
    id: 'q9',
    question: 'Which type of sound has frequency less than 20 Hz?',
    options: ['Audible sound', 'Ultrasonic sound', 'Infrasonic sound', 'Musical sound'],
    correctAnswer: 'C',
    explanation: 'Infrasonic sound: frequency < 20 Hz.'
  },
  {
    id: 'q10',
    question: 'What is one use of ultrasonic sound?',
    options: [
      'Listening to music',
      'SONAR - locating objects underwater',
      'Making phone calls',
      'Radio broadcasting'
    ],
    correctAnswer: 'B',
    explanation: 'SONAR uses ultrasonic sound.'
  }
];

export default function TestResults() {
  const params = useParams();
  const router = useRouter();
  const searchParams = useSearchParams();
  const [answers, setAnswers] = useState<Record<string, string>>({});

  const score = parseInt(searchParams.get('score') || '0');
  const correct = parseInt(searchParams.get('correct') || '0');
  const total = parseInt(searchParams.get('total') || '10');

  useEffect(() => {
    const userId = sessionStorage.getItem('userId');
    if (!userId) {
      router.push('/login');
      return;
    }

    const answersParam = searchParams.get('answers');
    if (answersParam) {
      setAnswers(JSON.parse(decodeURIComponent(answersParam)));
    }
  }, [router, searchParams]);

  const getPerformanceData = () => {
    if (score >= 80) return {
      level: 'Excellent!',
      color: 'text-green-600',
      bgColor: 'bg-green-50',
      borderColor: 'border-green-300',
      emoji: 'üåü',
      message: 'Outstanding performance! You have mastered the Sound chapter!',
      action: 'complete'
    };
    if (score >= 60) return {
      level: 'Good!',
      color: 'text-blue-600',
      bgColor: 'bg-blue-50',
      borderColor: 'border-blue-300',
      emoji: 'üëç',
      message: 'Well done! A few topics need revision, but you\'re doing great!',
      action: 'revision'
    };
    return {
      level: 'Needs Improvement',
      color: 'text-orange-600',
      bgColor: 'bg-orange-50',
      borderColor: 'border-orange-300',
      emoji: 'üí™',
      message: 'Don\'t worry! Let\'s review the concepts you found challenging.',
      action: 'revision'
    };
  };

  const performance = getPerformanceData();
  const wrongAnswers = TEST_QUESTIONS.filter(q => answers[q.id] !== q.correctAnswer);

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
      <div className="max-w-3xl mx-auto py-8">
        {/* Score Card */}
        <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
          <div className="text-center mb-6">
            <div className="w-24 h-24 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <span className="text-5xl">{performance.emoji}</span>
            </div>
            <h1 className="text-3xl font-bold text-gray-900 mb-2">
              Test Complete!
            </h1>
          </div>

          {/* Score Display */}
          <div className={`${performance.bgColor} rounded-xl p-8 border-2 ${performance.borderColor} mb-6`}>
            <div className="text-center">
              <div className={`text-6xl font-bold ${performance.color} mb-2`}>
                {Math.round(score)}%
              </div>
              <p className="text-xl text-gray-900 mb-3">
                {correct} out of {total} questions correct
              </p>
              <p className={`text-2xl font-semibold ${performance.color}`}>
                {performance.level}
              </p>
            </div>
          </div>

          <p className="text-gray-900 text-center mb-6">
            {performance.message}
          </p>

          {/* Action Buttons */}
          <div className="space-y-3">
            {performance.action === 'revision' ? (
              <Link
                href={`/chapter/${params.id}/revision?wrong=${encodeURIComponent(JSON.stringify(wrongAnswers.map(q => q.id)))}&score=${score}`}
                className="block w-full bg-orange-600 text-white py-4 rounded-lg font-semibold hover:bg-orange-700 transition text-center text-lg"
              >
                Continue to Revision ‚Üí
              </Link>
            ) : (
              <Link
                href="/dashboard"
                className="block w-full bg-green-600 text-white py-4 rounded-lg font-semibold hover:bg-green-700 transition text-center text-lg"
              >
                ‚úÖ Complete Chapter ‚Üí Dashboard
              </Link>
            )}
            <Link
              href={`/chapter/${params.id}`}
              className="block w-full bg-white border-2 border-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-50 transition text-center"
            >
              Back to Chapter Overview
            </Link>
          </div>
        </div>

        {/* Wrong Answers Review */}
        {wrongAnswers.length > 0 && (
          <div className="bg-white rounded-2xl shadow-xl p-8">
            <h2 className="text-2xl font-bold text-gray-900 mb-4">
              üìù Review Your Mistakes
            </h2>
            <p className="text-gray-700 mb-6">
              Let&apos;s learn from these {wrongAnswers.length} questions:
            </p>

            <div className="space-y-6">
              {wrongAnswers.map((q, idx) => {
                const userAnswer = answers[q.id];
                const userAnswerIndex = userAnswer ? userAnswer.charCodeAt(0) - 65 : -1;
                const correctAnswerIndex = q.correctAnswer.charCodeAt(0) - 65;

                return (
                  <div key={q.id} className="border-2 border-red-200 rounded-lg p-4 bg-red-50">
                    <p className="font-semibold text-gray-900 mb-3">
                      {idx + 1}. {q.question}
                    </p>
                    <div className="space-y-2 mb-3">
                      <p className="text-red-600">
                        ‚ùå Your answer: {userAnswerIndex >= 0 ? q.options[userAnswerIndex] : 'No answer'}
                      </p>
                      <p className="text-green-600">
                        ‚úì Correct answer: {q.options[correctAnswerIndex]}
                      </p>
                    </div>
                    <div className="bg-blue-50 border-l-4 border-blue-500 p-3">
                      <p className="text-sm text-gray-900">
                        <span className="font-semibold">üí° Explanation:</span> {q.explanation}
                      </p>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
